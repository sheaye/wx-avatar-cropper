# wx-avatar-cropper
仿微信截取头像的小程序截图工具

### 效果图
![图片](https://raw.githubusercontent.com/sheaye/wx-avatar-cropper/master/screenshot/cropper_page.jpg)

### 整体思路：
1. 实现图片的缩放和拖动；
2. 在图片上方盖上中间镂空的半透明遮罩；
3. 截取方框区域的图片。截图时，在方框区域将截取的图片绘制出来，然后使用`wx.canvasToTempFilePath`截取图片。

### 实现过程和遇到的问题：
1. 实现缩放和拖动最初是使用`touchStart`和`touhMove`，处理触摸事件来实现图片的缩放和拖动，但是这样的实现在小程序上会很卡。后来无意中发现了小程序提供的`movable-area`和`movable-view`可以很方便地实现控件的拖动和缩放。
2. 使用`canvas`绘制图片上方的半透明遮罩，最初我是把`canvas`放在`movable-aread`的上方，也就是在`wxml`文件中排在`movable-area`后面，这样会导致图片监听不了拖动事件和缩放事件。后来我将`canvas`前置，利用小程序中`canvas`在最上层的特点，实现遮罩，而又不影响图片的拖动和缩放。
3. 使用给`canvas`设置`rgb(0,0,0,0.5)`来实现canvas的半透明，而不是使用其`opacity`属性。因为在小程序中实现截图，需要先通过`canvas`将图片绘制出来。如果使用`opacity`绘制出来的图片也是半透明的，由于尺寸的误差，`canvas`绘制的图片和后面显示的图片会出现重影，效果不佳。
4. `canvas`不对底部栏覆盖。我这里是使用绝对定位，`canvas`相对屏幕底部`120rpx`，底部栏的高度正好也是`120rpx`。这里也可以使用其他方法实现。
5. `canvas`准确绘制要截取的图片。关键在于以下几个参数：源图片的大小尺寸，当前图片显示的尺寸、方框在显示的图片中的位置和大小。而方框在显示的图片中的位置又是通过方框和显示的图片分别相对于屏幕的位置得到。根据方框在显示图片中的位置和显示图片的尺寸求得一个比例，然后乘以源图片的位置，就拿到了方框在源图片中的位置和大小。
6. 在实现原微信截图终端"还原"的问题，在小程序上缩放和拖动不能同时进行，一步到位。具体原因在代码注释中有解释。
7. 解决截取图片拿不到文件的问题。重要的是要对`canvas`绘制图片加上监听，在`canvas`绘制图片完成后才提取图片文件。

### 依然存在的问题
1. 由于js计算的尺寸上的误差，用`canvas`绘制的图片和显示的图片会有个垂直方向上的轻微偏移。所以在点击`完成`时会有视觉上的头像移动的现象。这个误差的消除我还没仔细研究，如果网友有什么好的办法，可以告诉我。
2. 前面也提到了，点击“撤销”(微信里叫“还原”)，只能分两步撤销拖动和缩放，回到原来的位置。
3. 受限于`movable-area`图片拖动能超出边界的范围不多，这应该可以通过放大`movable-area`解决，不过这样的话后面的一系列定位算法都要更改。网友有需要的话可以自己实现。

### 博客：https://blog.csdn.net/KevinsCSDN/article/details/86476005
